#WIP

import requests
from bs4 import BeautifulSoup
import os

sessionId="xxx" #put session id here

baseHeaders = {'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
'Accept-Encoding': 'gzip, deflate, br',
'Accept-Language': 'en-US,en;q=0.5',
'Cache-Control': 'max-age=0',
'Connection': 'keep-alive',
'Cookie':f'MoodleSession={sessionId}; _gat=1',
'Host': 'lionel2.kgv.edu.hk',
'If-Modified-Since':'Wed, 26 Jan 2022 21:05:40 GMT',
'If-None-Match':"96ca96156b3a3c907a0a19359e2168a80229e900",
'Sec-Fetch-Dest':'document',
'Sec-Fetch-Mode':'navigate',
'Sec-Fetch-Site':'cross-site',
'Sec-Fetch-User':'?1',
'Upgrade-Insecure-Requests': '1',
'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:95.0) Gecko/20100101 Firefox/95.0'}


link='https://lionel2.kgv.edu.hk/user/index.php?contextid=61452&roleid=0&id=3980&perpage=2000&search=&mode=0'

page=requests.get(link,headers=baseHeaders)

soup = BeautifulSoup(page.text, 'html.parser')

imagesRaw = soup.find_all('img')[1:] #gets all images, names are stored in alt
idsRaw = soup.find_all('a')

ids=[]
for att in idsRaw:
    if ('https://lionel2.kgv.edu.hk/user/view.php?id=') in str(att):
        y=str(att).find('&')
        x=str(att).find('?id')
        ids.append(str(att)[x+4:y]) #gets just the id from the <a> tag

ids=ids[::2] #every other element

names=[]
links=[]

for im in imagesRaw:
    links.append(im["src"].replace('f2','f3')) #gets just the links from the <img> tag, replaces f2 with f3 to get larger images
    im=str(im)
    names.append(im[im.find('of')+3:im.find(']"')+1]) #gets just the names from the <img> tag

ids.pop(-1)
for i in range(5): #cleaning data
    links.pop(-1)
    names.pop(-1)



    
print(len(names),len(ids),len(links)) #ensuring they're all the same size

### CURRENT STUDENT COUNT (SEP 2022) : 1887



### MAIN LOOP FOR UPDATING/CREATING STUDENT FOLDERS ###
for i in range(len(names)):
    yr = names[i][names[i].find('[')+1:names[i].find(']')-3] #year group, used for folder seperations
    if not yr:
        yr = names[i][names[i].find('[')+1:names[i].find(']')] #some people have no tutors
    try:
        os.mkdir(f'Student-Data/{yr}/{names[i]}') #mm folders

    except FileExistsError: #so that I can make it easy to update files/photos when i'm not ceebs
        pass

    
    f = open(f'Student-Data/{yr}/{names[i]}/student-data.txt','w') #thankfully already adaptive, creates file if doesnt exist, otherwise it overwrites

    out=f"""ID ---- {ids[i]}\nPhoto Link ---- {links[i]}"""

    f.write(out)


    rawPhoto=requests.get(links[i],headers=baseHeaders)
    f = open(f'Student-Data/{yr}/{names[i]}/photo.jpg','wb')
    f.write(rawPhoto.content)

    print(f'{i+1}/{len(names)}')



    



data=open('General-Scrapers/data.txt','w',encoding='utf-8')

s=soup.prettify()

data.write(s)

# names=[]
# x=soup.find_all('a')
# for item in x:
#     if item.string:
#         names.append(item.string.strip())

# photoids=[]
# imgs=soup.find_all('img')
# for image in imgs:
#     photoids.append(image['src'])