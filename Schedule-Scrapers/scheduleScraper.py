import os
import requests

#NOT CURRENTLY WORKING
#IDFK WHAT ICS IS DOING


moodleID="xxx"
currentDay=['thursday',1] #[monday,1] for monday week one, [thursday,2] for thurs week two, etc
days=['monday','tuesday','wednesday','thursday','friday']

headers={'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
'Accept-Encoding': 'gzip, deflate, br',
'Accept-Language': 'en-US,en;q=0.5',
'Cache-Control': 'max-age=0',
'Connection': 'keep-alive',
'Cookie':f'MoodleSession={moodleID};',
'Host': 'lionel2.kgv.edu.hk',
'If-Modified-Since':'Wed, 26 Jan 2022 21:05:40 GMT',
'If-None-Match':"96ca96156b3a3c907a0a19359e2168a80229e900",
'Sec-Fetch-Dest':'document',
'Sec-Fetch-Mode':'navigate',
'Sec-Fetch-Site':'cross-site',
'Sec-Fetch-User':'?1',
'Upgrade-Insecure-Requests': '1',
'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:95.0) Gecko/20100101 Firefox/95.0'}



def link(id):
    return f'https://lionel2.kgv.edu.hk/local/mis/calendar/timetable.php/9668/e637b5e2f8ec8eb6c5690f745facd66c.ics'

for yr in os.listdir('Student-Data'):
    if yr.isnumeric():
        for student in os.listdir(f'Student-Data/{yr}'): #list of all students
            raw = open(f'Student-Data/{yr}/{student}/student-data.txt','r')
            id=raw.read().split('\n')[0][8:] #parsing student id from data file

            rawICS=requests.get(link(id),headers=headers)
            x=open('Schedule-Scrapers/data.txt','w')
            x.write(rawICS.text)
            rawSch=(rawICS.text).split('\n')

            for i in range(len(rawSch)):
                rawSch[i]=rawSch[i].split(':')

            schedule=[]
            count=days.index(currentDay[0])+1
            ttl=0
            wCount=currentDay[1]
            flag=False

            for item in rawSch: #an odd way of getting the schedule starting from monday day 1, pls donate a more clean method
                if item[0] == 'DESCRIPTION':
                    
                    ttl+=1
                    print(item,ttl)
                    if ttl==6:
                        ttl=1
                        count+=1
                        if count == 6:
                            count = 1
                            if wCount==2:
                                wCount = 1
                            else: wCount = 2
                    print(count,wCount)
                    #count through the fortnite
                    if count == 1 and wCount == 1:
                        
                        if (not flag) or ttl%5:
                            schedule.append(item)
                            flag=True
                        elif flag:
                            break

                    elif flag:
                        schedule.append(item)
                        
            
            for item in rawSch:
                if item[0]=='DESCRIPTION':
                    print(item)


            
                    
            print(schedule)
            print(len(schedule))





            break
        break




            
